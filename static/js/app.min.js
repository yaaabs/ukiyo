// Optimized Ukiyo QR JavaScript
(function () {
  "use strict";

  // Prevent FOUC
  document.addEventListener("DOMContentLoaded", function () {
    document.documentElement.classList.add("loaded");
  });

  // Background image loading
  function loadBg() {
    const img = new Image();
    img.onload = () => document.documentElement.classList.add("bg-loaded");
    img.src = document.querySelector('meta[name="bg-url"]').content;
  }

  window.addEventListener("load", function () {
    loadBg();
    document.body.classList.remove("page-transition");
  });

  // Form handling
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector("form");
    const spinner = document.getElementById("spinner");
    const container = document.querySelector(".container");

    if (form && spinner) {
      form.addEventListener("submit", function (e) {
        container.classList.add("page-transition");
        spinner.style.display = "block";
        const btn = form.querySelector('button[type="submit"]');
        if (btn) {
          btn.textContent = "Generating...";
          btn.disabled = true;
        }
      });
    }

    // Navigation
    document.querySelectorAll(".nav-link").forEach((link) => {
      link.addEventListener("click", function (e) {
        if (this.getAttribute("href").startsWith("#")) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute("href"));
          if (target) target.scrollIntoView({ behavior: "smooth" });
        }
      });
    });
  });

  // Modal handling
  document.addEventListener("DOMContentLoaded", function () {
    const overlay = document.getElementById("about-modal-overlay");
    const closeBtn = document.getElementById("about-modal-close");
    const confirmBtn = document.getElementById("about-close-btn");
    const triggers = document.querySelectorAll(
      "#about-icon,#about-link-footer",
    );

    function openModal() {
      overlay.classList.add("active");
      document.body.style.overflow = "hidden";
    }

    function closeModal() {
      overlay.classList.remove("active");
      document.body.style.overflow = "";
    }

    triggers.forEach((trigger) => {
      trigger.addEventListener("click", function (e) {
        e.preventDefault();
        openModal();
      });
    });

    closeBtn?.addEventListener("click", closeModal);
    confirmBtn?.addEventListener("click", closeModal);

    overlay?.addEventListener("click", function (e) {
      if (e.target === overlay) {
        closeModal();
      }
    });
  });

  // Lazy load ads
  let adsLoaded = false;
  function loadAds() {
    if (!adsLoaded) {
      const script = document.createElement("script");
      script.async = true;
      script.src =
        "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4958673233812388";
      script.crossOrigin = "anonymous";
      document.head.appendChild(script);
      adsLoaded = true;
    }
  }

  ["mousedown", "touchstart", "keydown", "scroll"].forEach((event) => {
    document.addEventListener(event, loadAds, { once: true, passive: true });
  });

  setTimeout(loadAds, 3000);

  // Service worker
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", function () {
      navigator.serviceWorker
        .register("/static/sw.js")
        .then((reg) => console.log("SW registered:", reg))
        .catch((err) => console.log("SW registration failed:", err));
    });
  }
})();
